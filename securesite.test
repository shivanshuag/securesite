<?php
// $Id$

/**
 * @file
 * Tests for Secure Site module.
 */

/**
 * Functional test for Secure Site forced authentication.
 */
class SecureSiteForceFunctionalTest extends DrupalWebTestCase {
  /**
   * Implementation of getInfo().
   */
  function getInfo() {
    return array(
      'name' => t('Forced authentication functionality'),
      'description' => t('Test Secure Site forced authentication.'),
      'group' => t('Secure Site'),
    );
  }

  /**
   * Implementation of setUp().
   */
  function setUp() {
    parent::setUp('securesite');
  }

  /**
   * Test page request with forced authentication disabled.
   */
  function testSecureSiteForceNever() {
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Testing page request with forced authentication disabled.'));
  }

  /**
   * Test page request with forced authentication enabled.
   */
  function testSecureSiteForceAlways() {
    $this->drupalLogin($this->drupalCreateUser());
    variable_set('securesite_enabled', SECURESITE_ALWAYS);
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Testing forced authentication with logged-in user.'));
    $this->drupalHead('logout');
    $this->assertResponse(401, t('Testing log-out page with forced authentication.'));
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Testing forced authentication with logged out user.'));
  }

  /**
   * Test page request with forced authentication enabled when offline.
   */
  function testSecureSiteForceOffline() {
    variable_set('securesite_enabled', SECURESITE_OFFLINE);
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Testing online page request with forced authentication enabled when offline.'));
    variable_set('site_offline', TRUE);
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Testing offline page request with forced authentication enabled when offline.'));
  }

  /**
   * Test page request with forced authentication enabled on restricted pages.
   */
  function testSecureSiteForce403() {
    variable_set('securesite_enabled', SECURESITE_403);
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Requesting public page with forced authentication enabled on restricted pages.'));
    $this->drupalHead('admin');
    $this->assertResponse(401, t('Requesting restricted page with forced authentication enabled on restricted pages.'));
  }

  /**
   * Implementation of tearDown().
   */
  function tearDown() {
    variable_del('securesite_enabled');
    variable_del('site_offline');
    parent::tearDown();
  }
}

/**
 * Functional test for Secure Site boot with basic authentication.
 */
class SecureSiteBootBasicFunctionalTest extends DrupalWebTestCase {
  /**
   * Implementation of getInfo().
   */
  function getInfo() {
    return array(
      'name' => t('Basic authentication functionality'),
      'description' => t('Test Secure Site HTTP basic authentication.'),
      'group' => t('Secure Site'),
    );
  }

  /**
   * Implementation of setUp().
   */
  function setUp() {
    parent::setUp('securesite');
    variable_set('securesite_enabled', SECURESITE_ALWAYS);
  }

  /**
   * Test page request without credentials.
   */
  function testSecureSiteBootBasicEmpty() {
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Requesting page without credentials.'));
    $found_scheme = FALSE;
    if (stripos($this->drupalGetHeader('WWW-Authenticate'), 'Basic') === 0) {
      $found_scheme = TRUE;
    }
    $this->assertTrue($found_scheme, t('Checking for basic authentication scheme.'));
  }

  /**
   * Test page request with wrong password.
   */
  function testSecureSiteBootBasicWrong() {
    $user = $this->drupalCreateUser(array('access secured pages'));
    $this->curl_options[CURLOPT_USERPWD] = "$user->name:$user->pass";
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Trying wrong password.'));
  }

  /**
   * Test page request with correct password but no access.
   */
  function testSecureSiteBootBasicNoAccess() {
    $user = $this->drupalCreateUser();
    $this->curl_options[CURLOPT_USERPWD] = "$user->name:$user->pass_raw";
    $this->drupalGet(NULL);
    $this->assertResponse(403, t('Trying correct password for unauthorized user.'));
    $this->assertText('You have not been authorized to log in to secured pages.', t('Checking for access denied message when password is correct for unauthorized user.'));
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Checking for authentication challenge to clear credentials.'));
  }

  /**
   * Test page request with correct password and access.
   */
  function testSecureSiteBootBasicAccess() {
    $user = $this->drupalCreateUser(array('access secured pages'));
    $this->curl_options[CURLOPT_USERPWD] = "$user->name:$user->pass_raw";
    // Should work with all authentication methods enabled.
    variable_set('securesite_type', array(SECURESITE_DIGEST, SECURESITE_BASIC, SECURESITE_FORM));
    // Should work without forced authentication.
    variable_del('securesite_enabled');
    $this->drupalGet(NULL);
    $this->assertResponse(200, t('Trying correct password for authorized user.'));
    $this->assertText($user->name, t('Checking for user name when password is correct for authorized user.'));
    $this->assertText('My account', t('Checking for account link when password is correct for authorized user.'));
    $this->assertText('Log out', t('Checking for log-out link when password is correct for authorized user.'));
  }

  /**
   * Implementation of tearDown().
   */
  function tearDown() {
    variable_del('securesite_enabled');
    $this->curl_options = array();
    parent::tearDown();
  }
}

/**
 * Functional test for Secure Site boot with form authentication.
 */
class SecureSiteBootFormFunctionalTest extends DrupalWebTestCase {
  /**
   * Implementation of getInfo().
   */
  function getInfo() {
    return array(
      'name' => t('Form authentication functionality'),
      'description' => t('Test Secure Site HTML form authentication.'),
      'group' => t('Secure Site'),
    );
  }

  /**
   * Implementation of setUp().
   */
  function setUp() {
    parent::setUp('securesite');
    variable_set('securesite_enabled', SECURESITE_ALWAYS);
    variable_set('securesite_type', array(SECURESITE_FORM));
  }

  /**
   * Test page request without credentials.
   */
  function testSecureSiteBootFormEmpty() {
    $this->drupalGet(NULL);
    $this->assertFieldByXPath('//form[@id="securesite-user-login"]', '', t('Checking for log-in form when page is requested without credentials.'));
  }

  /**
   * Test page request with wrong password.
   */
  function testSecureSiteBootFormWrong() {
    $user = $this->drupalCreateUser(array('access secured pages'));
    $this->drupalPost(NULL, array('name' => $user->name, 'pass' => $user->pass), 'Log in');
    $this->assertText('Unrecognized user name and/or password.', t('Checking for error message when password is wrong.'));
    $this->assertFieldByXPath('//form[@id="securesite-user-login"]', '', t('Checking for log-in form when password is wrong.'));
  }

  /**
   * Test page request with correct password.
   */
  function testSecureSiteBootFormCorrect() {
    $user = $this->drupalCreateUser(array('access secured pages'));
    // Should work with all authentication methods enabled.
    variable_set('securesite_type', array(SECURESITE_DIGEST, SECURESITE_BASIC, SECURESITE_FORM));
    // Should work without forced authentication.
    variable_del('securesite_enabled');
    $this->drupalPost(NULL, array('name' => $user->name, 'pass' => $user->pass_raw), 'Log in');
    $this->assertText($user->name, t('Checking for user name when password is correct.'));
    $this->assertText('My account', t('Checking for account link when password is correct.'));
    $this->assertText('Log out', t('Checking for log-out link when password is correct.'));
  }

  /**
   * Implementation of tearDown().
   */
  function tearDown() {
    variable_del('securesite_enabled');
    variable_del('securesite_type');
    parent::tearDown();
  }
}

/**
 * Functional test for Secure Site boot with digest authentication.
 */
class SecureSiteBootDigestFunctionalTest extends DrupalWebTestCase {
  /**
   * Implementation of getInfo().
   */
  function getInfo() {
    return array(
      'name' => t('Digest authentication functionality'),
      'description' => t('Test Secure Site HTTP digest authentication. Digest scripts should be working on the live site before this test is run.'),
      'group' => t('Secure Site'),
    );
  }

  /**
   * Implementation of setUp().
   */
  function setUp() {
    parent::setUp('securesite');
    _securesite_copy_script_config($this);
    variable_set('securesite_enabled', SECURESITE_ALWAYS);
  }

  /**
   * Test page request without credentials.
   */
  function testSecureSiteBootDigestEmpty() {
    variable_set('securesite_type', array(SECURESITE_DIGEST));
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Requesting page without credentials.'));
    $challenge = array();
    list($scheme, $value) = explode(' ', $this->drupalGetHeader('WWW-Authenticate'), 2);
    if ($scheme == 'Digest') {
      $challenge = _securesite_parse_directives($value);
    }
    $this->assertTrue(isset($challenge['realm']) && isset($challenge['nonce']), t('Checking for digest authentication scheme.'));
  }

  /**
   * Test page request with unstored password and basic fallback.
   */
  function testSecureSiteBootDigestUnstoredBasic() {
    $user = $this->drupalCreateUser(array('access secured pages'));
    variable_set('securesite_type', array(SECURESITE_DIGEST, SECURESITE_BASIC));
    $this->curl_options[CURLOPT_HTTPAUTH] = CURLAUTH_DIGEST | CURLAUTH_BASIC;
    $this->curl_options[CURLOPT_USERPWD] = "$user->name:$user->pass_raw";
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Trying unstored password with basic fallback.'));
    $found_scheme = FALSE;
    if (stripos($this->drupalGetHeader('WWW-Authenticate', TRUE), 'Basic') === 0) {
      $found_scheme = TRUE;
    }
    $this->assertTrue($found_scheme, t('Checking for basic authentication fall-back.'));
    user_delete(array(), $user->uid);
  }

  /**
   * Test page request with unstored password and form fallback.
   */
  function testSecureSiteBootDigestUnstoredForm() {
    $user = $this->drupalCreateUser(array('access secured pages'));
    variable_set('securesite_type', array(SECURESITE_DIGEST, SECURESITE_FORM));
    $this->curl_options[CURLOPT_HTTPAUTH] = CURLAUTH_DIGEST;
    $this->curl_options[CURLOPT_USERPWD] = "$user->name:$user->pass_raw";
    $this->drupalGet(NULL);
    $this->assertResponse(200, t('Trying unstored password with form fallback.'));
    $this->assertFieldByXPath('//form[@id="securesite-user-login"]', '', t('Checking for form authentication fall-back.'), 'Other');
  }

  /**
   * Test page request with wrong password.
   */
  function testSecureSiteBootDigestWrong() {
    variable_set('securesite_type', array(SECURESITE_DIGEST));
    $user = $this->drupalCreateUser(array('access secured pages'));
    $this->curl_options[CURLOPT_HTTPAUTH] = CURLAUTH_DIGEST;
    $this->curl_options[CURLOPT_USERPWD] = "$user->name:$user->pass";
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Trying wrong password.'));
    $challenge = array();
    list($scheme, $value) = explode(' ', $this->drupalGetHeader('WWW-Authenticate'), 2);
    if ($scheme == 'Digest') {
      $challenge = _securesite_parse_directives($value);
    }
    $this->assertTrue(isset($challenge['realm']) && isset($challenge['nonce']), t('Checking for challenge to wrong password.'));
    user_delete(array(), $user->uid);
  }

  /**
   * Test page request with correct password.
   */
  function testSecureSiteBootDigestCorrect() {
    // Should work with all authentication methods enabled.
    variable_set('securesite_type', array(SECURESITE_DIGEST, SECURESITE_BASIC, SECURESITE_FORM));
    $user = $this->drupalCreateUser(array('access secured pages'));
    $this->curl_options[CURLOPT_HTTPAUTH] = CURLAUTH_DIGEST;
    $this->curl_options[CURLOPT_USERPWD] = "$user->name:$user->pass_raw";
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Trying correct password.'));
    $directives = _securesite_parse_directives($this->drupalGetHeader('Authentication-Info'));
    $this->assertTrue(isset($directives['rspauth']), t('Checking authentication info for correct password.'));
    user_delete(array(), $user->uid);
  }

  /**
   * Implementation of tearDown().
   */
  function tearDown() {
    variable_del('securesite_digest_script');
    variable_del('securesite_password_script');
    variable_del('securesite_enabled');
    variable_del('securesite_type');
    $this->curl_options = array();
    parent::tearDown();
  }
}

/**
 * Functional test for Secure Site guest basic authentication.
 */
class SecureSiteGuestBasicFunctionalTest extends DrupalWebTestCase {
  /**
   * Implementation of getInfo().
   */
  function getInfo() {
    return array(
      'name' => t('Guest basic authentication functionality'),
      'description' => t('Test Secure Site guest basic authentication.'),
      'group' => t('Secure Site'),
    );
  }

  /**
   * Implementation of setUp().
   */
  function setUp() {
    parent::setUp('securesite');
    variable_set('securesite_enabled', SECURESITE_ALWAYS);
    variable_set('securesite_type', array(SECURESITE_BASIC));
  }

  /**
   * Test guest log-in with guest name and password not set.
   */
  function testSecureSiteGuestBasicEmpty() {
    $perm = db_result(db_query("SELECT perm FROM {permission} WHERE rid = %d", DRUPAL_ANONYMOUS_RID));
    $name = $this->randomName();
    $pass = user_password();
    // Try no password without access.
    $this->curl_options[CURLOPT_USERPWD] = ':';
    $this->drupalGet(NULL);
    $this->assertResponse(403, t('Trying no password with guest access disabled.'));
    $this->assertText('Anonymous users are not allowed to log in to secured pages.', t('Checking for access denied message when guest access is disabled and no password is given.'));
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Repeating no password with guest access disabled.'));
    // Try no password with access.
    db_query("UPDATE {permission} SET perm = '%s' WHERE rid = %d", $perm .', access secured pages', DRUPAL_ANONYMOUS_RID);
    $this->curl_options[CURLOPT_USERPWD] = ':';
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Trying no password with guest access enabled.'));
    // Try random password without access.
    db_query("UPDATE {permission} SET perm = '%s' WHERE rid = %d", $perm, DRUPAL_ANONYMOUS_RID);
    $this->curl_options[CURLOPT_USERPWD] = "$name:$pass";
    $this->drupalGet(NULL);
    $this->assertResponse(401, t('Trying random password with guest access disabled.'));
    $this->assertText('Unrecognized user name and/or password.', t('Checking for error message when guest access is disabled and random password is given.'));
    // Try random password with access.
    db_query("UPDATE {permission} SET perm = '%s' WHERE rid = %d", $perm .', access secured pages', DRUPAL_ANONYMOUS_RID);
    $this->curl_options[CURLOPT_USERPWD] = "$name:$pass";
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Trying random password with guest access enabled.'));
    // Try registered user.
    $user = $this->drupalCreateUser();
    $this->curl_options[CURLOPT_USERPWD] = "$user->name:$user->pass_raw";
    $this->drupalHead(NULL);
    $this->assertResponse(403, t('Trying to log in registered user.'));
  }

  /**
   * Test guest log-in with guest name and password set.
   */
  function testSecureSiteGuestBasicFull() {
    $perm = db_result(db_query("SELECT perm FROM {permission} WHERE rid = %d", DRUPAL_ANONYMOUS_RID));
    db_query("UPDATE {permission} SET perm = '%s' WHERE rid = %d", $perm .', access secured pages', DRUPAL_ANONYMOUS_RID);
    $name = $this->randomName();
    $pass = user_password();
    variable_set('securesite_guest_name', $name);
    variable_set('securesite_guest_pass', $pass);
    // Try no password.
    $this->curl_options[CURLOPT_USERPWD] = ':';
    $this->drupalHead(NULL);
    $this->assertResponse(403, t('Trying no password'));
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Repeating no password'));
    // Try wrong password.
    $this->curl_options[CURLOPT_USERPWD] = "$name:";
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Trying wrong password'));
    // Try correct password.
    $this->curl_options[CURLOPT_USERPWD] = "$name:$pass";
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Trying correct password'));
  }

  /**
   * Implementation of tearDown().
   */
  function tearDown() {
    variable_del('securesite_enabled');
    variable_del('securesite_type');
    variable_del('securesite_guest_name');
    variable_del('securesite_guest_pass');
    parent::tearDown();
  }
}

/**
 * Functional test for Secure Site guest digest authentication.
 */
class SecureSiteGuestDigestFunctionalTest extends DrupalWebTestCase {
  /**
   * Implementation of getInfo().
   */
  function getInfo() {
    return array(
      'name' => t('Guest digest authentication functionality'),
      'description' => t('Test Secure Site guest digest authentication.'),
      'group' => t('Secure Site'),
    );
  }

  /**
   * Implementation of setUp().
   */
  function setUp() {
    parent::setUp('securesite');
    _securesite_copy_script_config($this);
    variable_set('securesite_enabled', SECURESITE_ALWAYS);
    variable_set('securesite_type', array(SECURESITE_DIGEST));
  }

  function testSecureSiteGuestDigest() {
    $this->curl_options[CURLOPT_HTTPAUTH] = CURLAUTH_DIGEST;
    $user = $this->drupalCreateUser(array('administer site configuration', 'access secured pages'));
    $perm = db_result(db_query("SELECT perm FROM {permission} WHERE rid = %d", DRUPAL_ANONYMOUS_RID));
    db_query("UPDATE {permission} SET perm = '%s' WHERE rid = %d", $perm .', access secured pages', DRUPAL_ANONYMOUS_RID);
    // Try empty password.
    $this->curl_options[CURLOPT_USERPWD] = ':';
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Trying no password.'));
    $this->assertFalse($this->drupalGetHeader('Authentication-Info'), t('Checking digest authentication bypass when guest name and password are not set.'));
    // Try unstored password.
    $name = $this->randomName();
    $pass = user_password();
    variable_set('securesite_guest_name', $name);
    variable_set('securesite_guest_pass', $pass);
    $this->curl_options[CURLOPT_USERPWD] = "$name:$pass";
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Trying unstored password.'));
    // Prevent previous authentication header from being re-used when name and
    // password are repeated.
    $this->curlClose();
    // Store guest password.
    $this->curl_options[CURLOPT_USERPWD] = "$user->name:$user->pass_raw";
    $this->drupalPost('admin/settings/securesite', array('securesite_guest_name' => $name, 'securesite_guest_pass' => $pass, 'securesite_type['. SECURESITE_DIGEST .']' => TRUE), 'Save configuration');
    $this->drupalHead('logout');
    // Try wrong password.
    $this->curl_options[CURLOPT_USERPWD] = "$name:";
    $this->drupalHead(NULL);
    $this->assertResponse(401, t('Trying wrong password.'));
    // Try stored password.
    $this->curl_options[CURLOPT_USERPWD] = "$name:$pass";
    $this->drupalHead(NULL);
    $this->assertResponse(200, t('Trying stored password.'));
    $directives = _securesite_parse_directives($this->drupalGetHeader('Authentication-Info'));
    $this->assertTrue(isset($directives['rspauth']), t('Checking authentication info for correct password.'));
    // Delete guest password.
    $this->curl_options[CURLOPT_USERPWD] = "$user->name:$user->pass_raw";
    $this->drupalPost('admin/settings/securesite', array(), 'Reset to defaults');
    variable_set('securesite_type', array(SECURESITE_DIGEST));
    _securesite_copy_script_config($this);
    user_delete(array(), $user->uid);
  }

  /**
   * Implementation of tearDown().
   */
  function tearDown() {
    variable_del('securesite_digest_script');
    variable_del('securesite_password_script');
    variable_del('securesite_enabled');
    variable_del('securesite_type');
    parent::tearDown();
  }
}

/**
 * Copy script configuration from live site to test site.
 *
 * @param $object
 *   Object to which scripts should be copied.
 */
function _securesite_copy_script_config($object) {
  global $conf, $db_prefix;
  $conf = array();
  $_db_prefix = $db_prefix;
  @include './'. conf_path() .'/settings.php';
  $conf = variable_init($conf);
  $object->digest_md5 = variable_get('securesite_digest_script', drupal_get_path('module', 'securesite') .'/digest_md5/digest_md5.php');
  $object->stored_passwords = variable_get('securesite_password_script', drupal_get_path('module', 'securesite') .'/digest_md5/stored_passwords.php');
  $conf = array();
  @include './'. conf_path() .'/settings.php';
  $db_prefix = $_db_prefix;
  $conf = variable_init($conf);
  variable_set('securesite_digest_script', $object->digest_md5);
  variable_set('securesite_password_script', $object->stored_passwords);
}

